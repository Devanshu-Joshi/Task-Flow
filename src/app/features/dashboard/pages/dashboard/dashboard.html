<div class="page-wrapper" [class.loading]="isLoading()">
    <!-- your entire dashboard UI -->
    <div class="min-h-full w-full bg-linear-to-r from-purple-600 via-fuchsia-600 to-indigo-600 flex items-center flex-col px-4 sm:px-6 lg:px-7
         py-4 sm:py-6 lg:py-7
         gap-6 sm:gap-8">

        <!-- Stats Card Component -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

            <app-stats-card title="Total Tasks" [value]="totalTasks()" subtitle="Tasks created so far" icon="bx-list-ul"
                theme="purple" />

            <app-stats-card title="Completed Tasks" [value]="completedTasks()" subtitle="Great job!"
                icon="bx-check-circle" theme="green" />

            <app-stats-card title="In Progress Tasks" [value]="inProgressTasks()" subtitle="Keep going!"
                icon="bx-loader-dots" theme="yellow" />

            <app-stats-card title="Incomplete Tasks" [value]="incompleteTasks()" subtitle="Needs attention"
                icon="bx-x-circle" theme="red" />

        </div>


        <div class="w-full bg-white rounded-lg px-10 pb-10 pt-7">
            <div class="flex flex-col lg:flex-row w-full gap-4 mb-5">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:flex gap-3 w-full">
                    <div class="relative w-full lg:flex-1 min-w-0">
                        <input type="search"
                            class="w-full border-2 border-gray-300 pr-10 pl-4 py-2 rounded-lg text-sm sm:text-base focus:outline-none"
                            placeholder="Search..." [formControl]="searchControl" />

                        <i
                            class="bx bx-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
                    </div>

                    <div>
                        <input #dateRangeInput ngxDaterangepickerMd [ngModel]="dateRange()"
                            (ngModelChange)="dateRange.set($event)" [autoApply]="false" [alwaysShowCalendars]="true"
                            [showClearButton]="true" [drops]="'down'" [opens]="'right'"
                            [locale]="{ format: 'DD/MM/YYYY' }" [linkedCalendars]="true"
                            placeholder="Filter by date range"
                            class="border-2 border-gray-300 px-4 py-2 rounded-lg w-full lg:w-64 cursor-pointer" />
                    </div>

                    <div class="relative w-full lg:w-auto">
                        <ng-select class="status-select w-full lg:w-auto" [items]="statusOptions" bindLabel="label"
                            bindValue="value" [(ngModel)]="selectedStatus" (ngModelChange)="onStatusChange($event)"
                            [clearable]="false" [searchable]="false" [closeOnSelect]="true">

                            <!-- Placeholder -->
                            <ng-template ng-placeholder-tmp #placeholder>
                                <span class="text-gray-700 font-semibold">Status</span>
                            </ng-template>

                            <!-- Selected value -->
                            <ng-template ng-label-tmp let-item="item">
                                @if (item?.value !== null) {
                                <span [ngClass]="{
        'text-green-600': item.value === 'Completed',
        'text-yellow-600': item.value === 'InProgress',
        'text-red-600': item.value === 'Incomplete'
      }">
                                    {{ item.label }}
                                </span>
                                } @else {
                                <ng-template [ngTemplateOutlet]="placeholder"></ng-template>
                                }
                            </ng-template>

                            <!-- Dropdown options -->
                            <ng-template ng-option-tmp let-item="item">
                                <span [ngClass]="{
        'text-gray-700': item.value === null,
        'text-green-600': item.value === 'Completed',
        'text-yellow-600': item.value === 'InProgress',
        'text-red-600': item.value === 'Incomplete'
      }">
                                    {{ item.label }}
                                </span>
                            </ng-template>

                        </ng-select>
                    </div>

                    <div class="relative w-full lg:w-auto">

                        <ng-select class="tasks-per-page-select w-full lg:w-auto" [items]="pageSizeOptions"
                            [clearable]="false" [searchable]="false" [(ngModel)]="selectedPageSize"
                            (change)="setItemsPerPage($event)" [closeOnSelect]="true">

                            <!-- Custom label inside the selector -->
                            <ng-template ng-label-tmp let-item="item">
                                <span>
                                    Tasks per page : <strong>{{ item }}</strong>
                                </span>
                            </ng-template>

                            <!-- Custom option -->
                            <ng-template ng-option-tmp let-item="item">
                                {{ item }}
                            </ng-template>

                        </ng-select>

                    </div>

                </div>

                <div class="flex gap-2 shrink-0">
                    <button class="cursor-pointer py-2 px-2 rounded-lg bg-linear-to-r from-purple-600 to-indigo-600
                 text-white
                 shadow-md shadow-purple-500/30
                 hover:shadow-lg hover:shadow-purple-500/40
                 hover:scale-105
                 transition-all duration-200" (click)="toggleDialog()">Add Task</button>
                </div>
            </div>

            <div class="border border-gray-200 rounded-xl shadow-sm overflow-hidden bg-white">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-180 text-sm text-left border-collapse table-fixed">
                        <thead class="bg-gray-50 text-gray-600 uppercase text-xs sticky top-0">
                            <tr>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 cursor-pointer w-16 select-none"
                                    (click)="sortBy('createdAt')">
                                    S.No
                                    <i class="bx"
                                        [ngClass]="{'bx-caret-up': sortField() === 'createdAt' && sortDirection() === 'asc','bx-caret-down': sortField() === 'createdAt' && sortDirection() === 'desc'}"></i>
                                </th>

                                <th class="px-2 sm:px-4 py-2 sm:py-3 text-center w-1/3 cursor-pointer select-none"
                                    (click)="sortBy('title')">
                                    <span class="inline-flex items-center gap-1">
                                        Task

                                        <span class="flex flex-col text-xs leading-none">
                                            <i class="bx bx-caret-up"
                                                [ngClass]="{'text-gray-400': sortField() !== 'title' || sortDirection() === 'desc','text-gray-800': sortField() === 'title' && sortDirection() === 'asc'}"></i>

                                            <i class="bx bx-caret-down -mt-1"
                                                [ngClass]="{'text-gray-400': sortField() !== 'title' || sortDirection() === 'asc','text-gray-800': sortField() === 'title' && sortDirection() === 'desc'}"></i>
                                        </span>
                                    </span>
                                </th>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 font-semibold w-32 text-center">Status</th>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 font-semibold w-32 text-center">Due Date</th>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 font-semibold w-40 text-center">Action</th>
                            </tr>
                        </thead>

                        <tbody class="divide-y divide-gray-200">
                            @for (
                            item of filteredTasks() | paginate: { itemsPerPage: itemsPerPage, currentPage: p };
                            let index = $index;
                            track item.id
                            ) {
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-2 sm:px-4 py-2 sm:py-3 font-medium">
                                    {{ (p - 1) * itemsPerPage + index + 1 }}
                                </td>

                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-center font-medium text-gray-800 max-w-xs">
                                    {{ item.title }}
                                </td>

                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-center">
                                    <span
                                        class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
                                        [ngClass]="{
                      'bg-green-50 text-green-600': item.status === 'Completed',
                      'bg-blue-50 text-yellow-600': item.status === 'InProgress',
                      'bg-red-50 text-red-600': item.status === 'Incomplete'
                    }">
                                        {{ item.status }}
                                    </span>
                                </td>

                                <td class="px-2 sm:px-4 py-2 sm:py-3 text-gray-600 text-center">
                                    {{ item.dueDate | date: 'dd/MM/yyyy' }}
                                </td>

                                <td class="px-2 sm:px-4 py-2 sm:py-3 flex justify-center">
                                    <div class="flex items-center gap-2">
                                        <button
                                            class="flex items-center gap-1 px-3 py-1.5 rounded-md text-yellow-700 hover:bg-yellow-200 transition"
                                            (click)="edit(item)">
                                            <i class="bx bx-edit text-base"></i>
                                            Edit
                                        </button>

                                        <button
                                            class="flex items-center gap-1 px-3 py-1.5 rounded-md text-red-700 hover:bg-red-200 transition"
                                            (click)="delete(item)">
                                            <i class="bx bx-trash text-base"></i>
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            }
                            @empty {
                            <tr>
                                <td colspan="5">
                                    <div class="flex flex-col items-center justify-center py-14 text-center bg-gray-50 rounded-lg border border-dashed border-gray-200
">

                                        <!-- Icon -->
                                        <i class="bx bx-task text-5xl text-gray-300 mb-2"></i>

                                        <!-- Title -->
                                        <h3 class="text-lg font-semibold text-gray-700">
                                            Nothing to show here
                                        </h3>

                                        <!-- Description -->
                                        <p class="mt-1 text-sm text-gray-500 max-w-sm">
                                            Tasks will appear here when they’re available <br />or match your criteria.
                                        </p>

                                    </div>
                                </td>
                            </tr>
                            }

                            <!-- Footer row (total + pagination) -->
                            <tr>
                                <td colspan="5">
                                    <div class="flex w-full justify-between items-end">
                                        <div class="p-5 text-sm text-gray-500">
                                            Total Tasks :
                                            <span class="ml-1 font-bold text-gray-900">
                                                {{ filteredTasks().length }}
                                            </span>
                                        </div>

                                        <div class="pt-10 flex items-start">
                                            <button (click)="clearFilters()" class="px-2 py-1 text-sm font-medium text-gray-500
         hover:text-gray-700 hover:underline
         focus:outline-none cursor-pointer">
                                                Clear Filters
                                            </button>
                                            @if(filteredTasks().length > itemsPerPage && filteredTasks().length > 0) {
                                            <pagination-controls previousLabel="Prev" nextLabel="Next"
                                                (pageChange)="p = $event">
                                            </pagination-controls>
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        @if (showStatusDropdown) {
        <div #statusDropdown class="fixed z-9999 w-44 bg-white border border-gray-200 rounded-md shadow-lg"
            [style.top.px]="dropdownPosition.top" [style.left.px]="dropdownPosition.left">
            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 cursor-pointer"
                (click)="selectStatus('')">
                All
            </button>

            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-green-600 cursor-pointer"
                (click)="selectStatus('Completed')">
                Completed
            </button>

            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-yellow-600 cursor-pointer"
                (click)="selectStatus('InProgress')">
                In Progress
            </button>

            <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600 cursor-pointer"
                (click)="selectStatus('Incomplete')">
                Incomplete
            </button>
        </div>
        }

        @if(isDialogClosed == false) {

        <div class="fixed top-0 left-0 w-full h-full bg-black/40 backdrop-blur-md z-40 transition-opacity"></div>

        <div class="fixed top-0 left-0 w-full h-full z-50 flex items-center justify-center">
            <div
                class="relative w-full max-w-md px-4 bg-white rounded-2xl shadow-xl shadow-black/10 border border-gray-200">

                <div class="absolute top-4 right-4">
                    <button type="button" (click)="toggleDialog()"
                        class="rounded-full p-1 text-gray-500 hover:text-gray-800 hover:bg-gray-100 flex items-center transition cursor-pointer">
                        <i class='bx bx-x text-2xl'></i>
                    </button>
                </div>

                <div class="px-8 pt-8 pb-4 text-center">
                    <p class="text-2xl font-semibold tracking-tight"
                        [ngClass]="{'text-black': dialogTitleColor() === 'text-primary','text-yellow-500': dialogTitleColor() === 'text-warn','text-red-600': dialogTitleColor() === 'text-danger'}">
                        {{dialogTitle()}} Task
                    </p>
                    <p class="text-sm text-gray-500 mt-1">
                        {{dialogDescription()}}
                    </p>
                </div>

                <form [formGroup]="taskForm" (ngSubmit)="submit()" class="px-8 pb-8">

                    <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-3
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                        <i class='bx bx-edit text-gray-400'></i>
                        <input type="text" formControlName="title"
                            class="w-full outline-none text-sm placeholder-gray-400" placeholder="Task Name" [ngClass]="{
                            'cursor-not-allowed': isDeleting(),
                            'cursor-auto': !isDeleting()
                        }" />
                    </div>

                    @if(taskForm.controls.title.touched && taskForm.controls.title.invalid) {
                    <p class="text-red-500 text-xs mt-1">
                        Task name is required (min 3 chars)
                    </p>
                    }

                    <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-4
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                        <i class='bx bx-calendar text-gray-400'></i>
                        <input type="date" formControlName="dueDate" class="w-full outline-none text-sm" [ngClass]="{
                            'cursor-not-allowed': isDeleting(),
                            'cursor-auto': !isDeleting()
                        }" />
                    </div>

                    @if(taskForm.controls.dueDate.touched && taskForm.controls.dueDate.invalid) {
                    <p class="text-red-500 text-xs mt-1">
                        Due date is required
                    </p>
                    }

                    <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-4
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                        <i class='bx bx-flag text-gray-400'></i>
                        <select formControlName="status" class="w-full outline-none text-sm bg-transparent" [ngClass]="{
                            'cursor-auto': !isDeleting(),
                            'cursor-not-allowed': isDeleting(),
                        }">
                            <option value="Incomplete">Incomplete</option>
                            <option value="Completed">Completed</option>
                            <option value="InProgress">In Progress</option>
                        </select>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button type="button" (click)="cancelDialog()" class="w-full py-3 rounded-xl font-medium
               text-gray-700 bg-gray-100
               hover:bg-gray-200
               transition-all duration-200 cursor-pointer">
                            Cancel
                        </button>

                        <button type="submit"
                            [ngClass]="{'submit-btn text-white': dialogTitleColor() === 'text-primary','edit-btn text-white': dialogTitleColor() === 'text-warn','delete-btn text-white': dialogTitleColor() === 'text-danger'}"
                            [disabled]="taskForm.invalid">
                            {{dialogSubmitText()}} Task
                        </button>

                    </div>

                </form>
            </div>
        </div>

        }
    </div>
</div>

<div class="loader-overlay" *ngIf="isLoading()">
    <div class="spinner"></div>
    <p>Loading tasks…</p>
</div>