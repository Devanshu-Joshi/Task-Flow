<div
    class="min-h-screen w-full bg-linear-to-r from-purple-600 via-fuchsia-600 to-indigo-600 flex items-center flex-col px-7">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

        <div class="bg-white rounded-xl p-5 flex justify-between items-center shadow-sm mt-15">
            <div class="flex flex-col gap-3">
                <p class="text-sm font-semibold text-gray-500">Total Tasks</p>
                <p class="text-2xl font-bold text-gray-900">{{ totalTasks() }}</p>
                <p class="text-sm text-gray-400">Tasks created so far</p>
            </div>
            <div class="bg-purple-100 rounded-lg p-2 flex items-center">
                <i class="bx bx-list-ul text-3xl text-purple-600"></i>
            </div>
        </div>

        <div class="bg-white rounded-xl p-5 flex justify-between items-center shadow-sm mt-15">
            <div class="flex flex-col gap-3">
                <p class="text-sm font-semibold text-gray-500">Completed Tasks</p>
                <p class="text-2xl font-bold text-gray-900">{{ completedTasks() }}</p>
                <p class="text-sm text-green-600">Great job!</p>
            </div>
            <div class="bg-green-100 p-2 rounded-lg flex items-center">
                <i class="bx bx-check-circle text-3xl text-green-600"></i>
            </div>
        </div>

        <div class="bg-white rounded-xl p-5 flex justify-between items-center shadow-sm mt-15">
            <div class="flex flex-col gap-3">
                <p class="text-sm font-semibold text-gray-500">In Progress Tasks</p>
                <p class="text-2xl font-bold text-gray-900">{{ inProgressTasks() }}</p>
                <p class="text-sm text-yellow-600">Keep going!</p>
            </div>
            <div class="bg-yellow-100 p-2 rounded-lg flex items-center">
                <i class="bx bx-loader-dots text-3xl text-yellow-600"></i>
            </div>
        </div>

        <div class="bg-white rounded-xl p-5 flex justify-between items-center shadow-sm mt-15">
            <div class="flex flex-col gap-3">
                <p class="text-sm font-semibold text-gray-500">Incomplete Tasks</p>
                <p class="text-2xl font-bold text-gray-900">{{ incompleteTasks() }}</p>
                <p class="text-sm text-red-600">Needs attention</p>
            </div>
            <div class="bg-red-100 p-2 rounded-lg flex items-center">
                <i class="bx bx-x-circle text-3xl text-red-600"></i>
            </div>
        </div>

    </div>
    <div class="w-full bg-white rounded-lg px-10 pb-10 pt-7">
        <div class="flex w-full justify-between mb-5">
            <div class="flex gap-3 relative">
                <div class="relative w-72">
                    <input type="search"
                        class="w-full border-2 border-gray-300 pr-10 pl-4 py-2 rounded-lg focus:outline-none"
                        placeholder="Search..." [formControl]="searchControl" />

                    <i class="bx bx-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
                </div>

                <div class="relative inline-block">

                    <button
                        class="flex items-center gap-2 border-2 border-gray-300 px-4 py-2 rounded-lg hover:border-indigo-500 transition"
                        (click)="openTasksDropdown($event)">

                        <span>
                            Tasks per page: <strong>{{ selectedPageSize() }}</strong>
                        </span>

                        <i class="bx bx-chevron-down text-sm text-gray-500"></i>
                    </button>

                    @if (isTasksDropdownOpen) {
                    <div class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                        @for (option of pageSizeOptions; track option) {
                        <button (click)="setItemsPerPage(option)"
                            class="w-full px-4 py-2 text-left hover:bg-indigo-50 transition"
                            [class.font-semibold]="option === selectedPageSize()">
                            {{ option }}
                        </button>
                        }
                    </div>
                    }

                </div>

                <div class="relative">
                    <button
                        class="flex items-center gap-2 border-2 border-gray-300 px-4 py-2 rounded-lg hover:border-indigo-500 transition cursor-pointer"
                        (click)="openStatusDropdown($event)">

                        <span
                            [ngClass]="{'text-gray-700': !selectedStatus(),'text-green-600': selectedStatus() === 'Completed','text-yellow-600': selectedStatus() === 'InProgress','text-red-600': selectedStatus() === 'Incomplete'}">

                            {{ selectedStatus()
                            ? (selectedStatus() === 'InProgress' ? 'In Progress' : selectedStatus())
                            : 'Status' }}
                        </span>

                        <i class="bx bx-chevron-down text-sm text-gray-500"></i>
                    </button>
                </div>

                <input #dateRangeInput ngxDaterangepickerMd [ngModel]="dateRange()"
                    (ngModelChange)="dateRange.set($event)" [autoApply]="false" [alwaysShowCalendars]="true"
                    [showClearButton]="true" [drops]="'down'" [opens]="'right'" [locale]="{ format: 'DD/MM/YYYY' }"
                    [linkedCalendars]="true" placeholder="Filter by date range"
                    class="border-2 border-gray-300 px-4 py-2 rounded-lg w-64 cursor-pointer" />
            </div>

            <div class="flex gap-2">
                <button class="cursor-pointer py-2 px-2 rounded-lg bg-linear-to-r from-purple-600 to-indigo-600
                 text-white
                 shadow-md shadow-purple-500/30
                 hover:shadow-lg hover:shadow-purple-500/40
                 hover:scale-105
                 transition-all duration-200" (click)="toggleDialog()">Add Task</button>
            </div>
        </div>

        <div class="border border-gray-200 rounded-xl shadow-sm overflow-hidden bg-white">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="px-4 py-3 font-semibold">Task</th>
                            <th class="px-4 py-3 font-semibold text-center">Status</th>
                            <th class="px-4 py-3 font-semibold text-center">Due Date</th>
                            <th class="px-4 py-3 font-semibold text-center">Action</th>
                        </tr>
                    </thead>

                    <tbody class="divide-y divide-gray-200">
                        @for (item of filteredTasks() | paginate: { itemsPerPage: itemsPerPage, currentPage: p }; track
                        item.id) {
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-4 py-3 font-medium text-gray-800">
                                {{ item.title }}
                            </td>

                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold"
                                    [ngClass]="{'bg-green-50 text-green-600': item.status === 'Completed','bg-blue-50 text-yellow-600': item.status === 'InProgress','bg-red-50 text-red-600': item.status === 'Incomplete'}">
                                    {{ item.status }}
                                </span>
                            </td>

                            <td class="px-4 py-3 text-gray-600 text-center">
                                {{ item.dueDate | date: 'dd/MM/yyyy' }}
                            </td>

                            <td class="px-4 py-3 flex justify-center">
                                <div class="flex items-center gap-2">
                                    <button
                                        class="flex items-center gap-1 px-3 py-1.5 rounded-md text-yellow-700 hover:bg-yellow-200 transition cursor-pointer"
                                        (click)="edit(item)">
                                        <i class="bx bx-edit text-base"></i>
                                        <span class="cursor-pointer">Edit</span>
                                    </button>

                                    <button
                                        class="flex items-center gap-1 px-3 py-1.5 rounded-md text-red-700 hover:bg-red-200 transition cursor-pointer"
                                        (click)="delete(item)">
                                        <i class="bx bx-trash text-base"></i>
                                        <span class="cursor-pointer">Delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                        <tr>
                            <td colspan="4">
                                <div class="flex w-full justify-between items-end">
                                    <div>
                                        <div class="p-5 text-sm text-gray-500">
                                            Total Tasks :
                                            <span class="ml-1 font-bold text-gray-900">
                                                {{ filteredTasks().length }}
                                            </span>
                                        </div>
                                    </div>


                                    <div class="pt-10">
                                        <pagination-controls previousLabel="Prev" nextLabel="Next"
                                            (pageChange)="p = $event"></pagination-controls>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    @if (showStatusDropdown) {
    <div #statusDropdown class="fixed z-9999 w-44 bg-white border border-gray-200 rounded-md shadow-lg"
        [style.top.px]="dropdownPosition.top" [style.left.px]="dropdownPosition.left">
        <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 cursor-pointer"
            (click)="selectStatus('')">
            All
        </button>

        <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-green-600 cursor-pointer"
            (click)="selectStatus('Completed')">
            Completed
        </button>

        <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-yellow-600 cursor-pointer"
            (click)="selectStatus('InProgress')">
            In Progress
        </button>

        <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600 cursor-pointer"
            (click)="selectStatus('Incomplete')">
            Incomplete
        </button>
    </div>
    }

    @if(isDialogClosed == false) {

    <div class="fixed inset-0 bg-black/40 backdrop-blur-md z-40 transition-opacity"></div>

    <div class="fixed inset-0 z-50 flex items-center justify-center px-4">
        <div class="relative w-full max-w-md bg-white rounded-2xl shadow-xl shadow-black/10 border border-gray-200">

            <div class="absolute top-4 right-4">
                <button type="button" (click)="toggleDialog()"
                    class="rounded-full p-1 text-gray-500 hover:text-gray-800 hover:bg-gray-100 flex items-center transition cursor-pointer">
                    <i class='bx bx-x text-2xl'></i>
                </button>
            </div>

            <div class="px-8 pt-8 pb-4 text-center">
                <p class="text-2xl font-semibold tracking-tight"
                    [ngClass]="{'text-black': dialogTitleColor() === 'text-primary','text-yellow-500': dialogTitleColor() === 'text-warn','text-red-600': dialogTitleColor() === 'text-danger'}">
                    {{dialogTitle()}} Task
                </p>
                <p class="text-sm text-gray-500 mt-1">
                    {{dialogDescription()}}
                </p>
            </div>

            <form [formGroup]="taskForm" (ngSubmit)="submit()" class="px-8 pb-8">

                <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-3
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                    <i class='bx bx-edit text-gray-400'></i>
                    <input type="text" formControlName="title" class="w-full outline-none text-sm placeholder-gray-400"
                        placeholder="Task Name" [ngClass]="{
                            'cursor-not-allowed': isDeleting(),
                            'cursor-auto': !isDeleting()
                        }" />
                </div>

                @if(taskForm.controls.title.touched && taskForm.controls.title.invalid) {
                <p class="text-red-500 text-xs mt-1">
                    Task name is required (min 3 chars)
                </p>
                }

                <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-4
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                    <i class='bx bx-calendar text-gray-400'></i>
                    <input type="date" formControlName="dueDate" class="w-full outline-none text-sm" [ngClass]="{
                            'cursor-not-allowed': isDeleting(),
                            'cursor-auto': !isDeleting()
                        }" />
                </div>

                @if(taskForm.controls.dueDate.touched && taskForm.controls.dueDate.invalid) {
                <p class="text-red-500 text-xs mt-1">
                    Due date is required
                </p>
                }

                <div class="flex items-center gap-2 border border-gray-300 rounded-xl px-3 py-2 my-4
                       focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500/20 transition">
                    <i class='bx bx-flag text-gray-400'></i>
                    <select formControlName="status" class="w-full outline-none text-sm bg-transparent" [ngClass]="{
                            'cursor-auto': !isDeleting(),
                            'cursor-not-allowed': isDeleting(),
                        }">
                        <option value="Incomplete">Incomplete</option>
                        <option value="Completed">Completed</option>
                        <option value="InProgress">In Progress</option>
                    </select>
                </div>

                <div class="mt-8 flex gap-3">
                    <button type="button" (click)="cancelDialog()" class="w-full py-3 rounded-xl font-medium
               text-gray-700 bg-gray-100
               hover:bg-gray-200
               transition-all duration-200 cursor-pointer">
                        Cancel
                    </button>

                    <button type="submit"
                        [ngClass]="{'submit-btn text-white': dialogTitleColor() === 'text-primary','edit-btn text-white': dialogTitleColor() === 'text-warn','delete-btn text-white': dialogTitleColor() === 'text-danger'}"
                        [disabled]="taskForm.invalid">
                        {{dialogSubmitText()}} Task
                    </button>

                </div>

            </form>
        </div>
    </div>

    }
</div>