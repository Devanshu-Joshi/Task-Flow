<div class="w-full bg-white rounded-lg px-4 sm:px-6 lg:px-10 pb-8 sm:pb-10 pt-6 sm:pt-7">

    <!-- User Table Filters -->
    <div class="flex flex-col lg:flex-row w-full gap-4 mb-5">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full min-w-0 lg:flex lg:flex-row relative">

            <!-- Search Input -->
            <div class="relative w-full min-w-0 sm:col-span-1 lg:flex-1 lg:min-w-36.25">
                <input type="search"
                    class="w-full border-2 border-gray-300 pr-10 pl-4 py-2 rounded-lg text-sm sm:text-base focus:outline-none h-11"
                    placeholder="Search..." [formControl]="searchControl" />
                <i class="bx bx-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
            </div>

            <!-- Role Select -->
            <div class="relative w-full min-w-20 sm:col-span-1 lg:w-50">
                <ng-select class="role-select w-full" [items]="roleOptions" bindLabel="label" bindValue="value"
                    [(ngModel)]="selectedRole" [clearable]="false" [searchable]="false" [closeOnSelect]="true">
                    <ng-template ng-placeholder-tmp #placeholder>
                        <span class="text-gray-700 font-semibold whitespace-nowrap">Role</span>
                    </ng-template>

                    <ng-template ng-label-tmp let-item="item">
                        @if (item?.value !== null) {
                        <span class="whitespace-nowrap" [ngClass]="{
                'text-green-500': item.value === 'ROLE_ADMIN',
                'text-yellow-500': item.value === 'ROLE_USER',
                'text-red-500': item.value === 'ROLE_GUEST'
              }">
                            {{ item.label }}
                        </span>
                        } @else {
                        <ng-template [ngTemplateOutlet]="placeholder"></ng-template>
                        }
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                        <span class="whitespace-nowrap" [ngClass]="{
              'text-gray-700': item.value === null,
              'text-green-500': item.value === 'ROLE_ADMIN',
              'text-yellow-500': item.value === 'ROLE_USER',
              'text-red-500': item.value === 'ROLE_GUEST'
            }">
                            {{ item.label }}
                        </span>
                    </ng-template>
                </ng-select>
            </div>

            <!-- Permission Select -->
            <div class="relative w-full min-w-38 sm:col-span-1 lg:w-50">
                <ng-select [items]="permissions" [multiple]="true" bindLabel="label" bindValue="key" groupBy="group"
                    [closeOnSelect]="false" placeholder="Permissions" [(ngModel)]="selectedPermissions"
                    (change)="onSelectionChange()" class="permission-select modern-select">

                    <ng-template ng-optgroup-tmp>
                        <label class="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" class="modern-checkbox" [checked]="isAllSelected()"
                                [indeterminate]="selectedPermissions.length > 0 && !isAllSelected()"
                                (click)="$event.stopPropagation()" (change)="toggleAll($event.target.checked)" />
                            <strong class="text-slate-700">All</strong>
                        </label>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item" let-item$="item$">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="modern-checkbox" [checked]="item$.selected" tabindex="-1"
                                pointer-events="none" />
                            <span class="text-slate-700">{{ item.label }}</span>
                        </div>
                    </ng-template>

                    <ng-template ng-multi-label-tmp let-items="items">
                        @if (isAllSelected()) {
                        <span class="badge badge-success">All Permissions</span>
                        }

                        @if (!isAllSelected() && items.length > 0) {
                        <span class="badge badge-warning">
                            {{ items.length }} Selected
                        </span>
                        }
                    </ng-template>

                </ng-select>
            </div>

            <!-- Date Picker -->
            <div class="w-full sm:col-span-2 lg:w-[18rem]">
                <input ngxDaterangepickerMd [(ngModel)]="dateRange" [autoApply]="false" [alwaysShowCalendars]="true"
                    [showClearButton]="true" [drops]="'down'" [opens]="'right'" [locale]="{ format: 'DD/MM/YYYY' }"
                    [linkedCalendars]="true" placeholder="Filter by date range"
                    class="border-2 border-gray-300 px-4 py-2 rounded-lg w-full cursor-pointer text-sm sm:text-base h-11"
                    (click)="toggleDatePicker()" />
            </div>

            <!-- Page Size Select (fixed width; fits label well) -->
            <div class="relative w-full min-w-44 sm:col-span-1 lg:w-52">
                <ng-select class="users-per-page-select filter-select w-full" [items]="pageSizeOptions"
                    [clearable]="false" [searchable]="false" [ngModel]="selectedPageSize()"
                    (ngModelChange)="onPageSizeChange($event)" [closeOnSelect]="true">
                    <ng-template ng-label-tmp let-item="item">
                        <span class="text-sm sm:text-base whitespace-nowrap">
                            Users per page : <strong>{{ item }}</strong>
                        </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                        {{ item }}
                    </ng-template>
                </ng-select>
            </div>

        </div>

        <!-- Add Task Button -->
        <div class="flex gap-2 w-full sm:col-span-1 lg:w-auto lg:shrink-0">
            <button class="cursor-pointer w-full lg:w-auto py-2 px-4 rounded-lg bg-linear-to-r from-purple-600 to-indigo-600
             text-white shadow-md shadow-purple-500/30
             hover:shadow-lg hover:shadow-purple-500/40
             lg:hover:scale-105 transition-all duration-200" (click)="toggleDialog()">
                Add User
            </button>
        </div>
    </div>

    <!-- User Table -->

    <div class="border border-gray-200 rounded-xl shadow-sm overflow-hidden bg-white">
        <!-- Scroll ONLY the table, not the footer -->
        <div class="overflow-x-auto">
            <table
                class="w-full min-w-160 md:min-w-180 text-xs sm:text-sm text-left border-collapse table-auto sm:table-fixed">
                <thead class="bg-gray-50 text-gray-600 uppercase text-[10px] sm:text-xs sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 w-12 text-center">S.No</th>

                        <th class="px-4 py-3 text-left">User</th>

                        <th class="px-4 py-3 text-center">Created Date</th>

                        <th class="px-4 py-3 text-center">Permissions</th>

                        <th class="px-4 py-3 text-center">Action</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200">
                    @for (
                    user of (users() | paginate: { itemsPerPage: itemsPerPage, currentPage: p });
                    let i = $index;
                    track user.id
                    ) {
                    <tr>

                        <!-- S.No -->
                        <td class="px-4 py-3 text-center font-medium">
                            {{ (p - 1) * itemsPerPage + i + 1 }}
                        </td>

                        <!-- User Info -->
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <img [src]="user.avatar || 'assets/avatar-placeholder.png'"
                                    class="w-9 h-9 rounded-full object-cover" alt="avatar" />
                                <div class="min-w-0">
                                    <p class="font-semibold text-gray-800 truncate">
                                        {{ user.name }}
                                    </p>
                                    <p class="text-xs text-gray-500 truncate">
                                        {{ user.email }}
                                    </p>
                                </div>
                            </div>
                        </td>

                        <!-- Created Date -->
                        <td class="px-4 py-3 text-center text-sm text-gray-700">
                            {{ user.createdAt | date:'dd MMM yyyy' }}
                        </td>

                        <!-- Permissions -->
                        <td class="px-4 py-3 text-center">
                            <div class="flex flex-wrap gap-1 justify-center">
                                @if (user.permissions.length) {
                                @for (perm of user.permissions; track perm) {
                                <span class="px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-700">
                                    {{ perm }}
                                </span>
                                }
                                } @else {
                                <span class="text-xs text-gray-400">No permissions</span>
                                }
                            </div>
                        </td>

                        <!-- Actions -->
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center gap-2">
                                <button class="text-blue-600 hover:text-blue-800" (click)="editUser(user)">
                                    <i class="bx bx-edit"></i>
                                </button>

                                <button class="text-red-600 hover:text-red-800" (click)="deleteUser(user.id)">
                                    <i class="bx bx-trash"></i>
                                </button>
                            </div>
                        </td>

                    </tr>
                    }
                    @empty {
                    <tr>
                        <td colspan="5" class="p-6">
                            <app-empty-state></app-empty-state>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Footer OUTSIDE scroll -->

    </div>

</div>