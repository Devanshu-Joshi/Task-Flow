<!-- Backdrop -->
<div class="fixed inset-x-0 bottom-0 top-16 z-30 bg-black/50
         transition-opacity duration-300 ease-out" [class.opacity-100]="isOpen" [class.opacity-0]="!isOpen"
    [class.pointer-events-auto]="isOpen" [class.pointer-events-none]="!isOpen" (click)="closeSidebar()"></div>

<!-- Sidebar -->
<aside class="fixed top-16 right-0 z-50 h-[calc(100vh-4rem)] w-full max-w-md translate-x-full
         bg-white/20 backdrop-blur-xl border-l border-white/30
         shadow-2xl flex flex-col transform transition-transform duration-300 ease-out" [class.translate-x-0]="isOpen"
    [class.translate-x-full]="!isOpen">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-white/20 flex items-center justify-between shrink-0">
        <h2 class="text-xl font-semibold text-white">
            @if (mode === 'add') { Add User }
            @else if (mode === 'edit') { Edit User }
            @else if (mode === 'view') { View User }
            @else { Delete User }
        </h2>
        <button class="text-white/70 hover:text-white text-lg cursor-pointer" (click)="closeSidebar()">
            ✕
        </button>
    </div>

    <!-- Form -->
    <form [formGroup]="userForm" class="flex flex-col min-h-0 text-white">
        <div class="flex-1 min-h-0 overflow-y-auto px-6 py-5 space-y-6">

            <!-- Name -->
            <div>
                <label class="text-sm font-medium mb-1 block text-white/80">Name</label>
                <input type="text" formControlName="name" class="w-full rounded-xl bg-white/20 border border-white/30
                 px-4 py-2.5 text-white placeholder-white/60
                 focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="John Doe" />
            </div>

            <!-- Email -->
            <div>
                <label class="text-sm font-medium mb-1 block text-white/80">Email</label>
                <input type="email" formControlName="email" class="w-full rounded-xl bg-white/20 border border-white/30
                 px-4 py-2.5 text-white placeholder-white/60
                 focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="john@example.com" />
            </div>

            <!-- Password -->
            @if (userForm.contains('password')) {
            <div>
                <label class="text-sm font-medium mb-1 block text-white/80">Password</label>
                <input type="password" formControlName="password" class="w-full rounded-xl bg-white/20 border border-white/30
             px-4 py-2.5 text-white placeholder-white/60
             focus:ring-2 focus:ring-indigo-400 outline-none" placeholder="••••••••" />
            </div>
            }

            <!-- Permissions -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-semibold text-white/90">Permissions</p>

                    @if (mode !== 'view' && mode !== 'delete') {
                    <button type="button" (click)="toggleAllPermissions()"
                        class="text-xs px-3 py-1.5 rounded-lg transition border">
                        {{ allPermissionsEnabled ? 'Disable All' : 'Enable All' }}
                    </button>
                    }
                </div>

                <div formArrayName="permissions" class="space-y-3">
                    @for (perm of permissionList; track $index; let i = $index) {
                    <div class="flex items-center justify-between bg-white/10
                rounded-xl px-4 py-3 border border-white/20">
                        <div class="flex items-center gap-1">
                            <span class="text-sm">{{ perm.label }}</span>

                            @if(perm.key === PermissionKey.TASK_VIEW){
                            <span class="text-xs text-white/50">(Required)
                            </span>
                            }
                        </div>

                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" [formControlName]="i" />

                            <div class="w-11 h-6 rounded-full
         bg-white/30
         peer-checked:bg-indigo-500
         peer-disabled:bg-white/10
         peer-disabled:opacity-50
         peer-disabled:cursor-not-allowed

         after:content-['']
         after:absolute after:top-0.5 after:left-0.5
         after:h-5 after:w-5 after:rounded-full
         after:bg-white
         after:transition-all

         peer-checked:after:translate-x-5
         peer-disabled:after:bg-white/60
  ">
                            </div>
                        </label>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="border-t border-white/20 px-6 py-4 flex gap-3">
            <button type="button" class="flex-1 rounded-xl bg-white/20 border border-white/30
           px-4 py-2.5 text-white hover:bg-white/30 transition" (click)="closeSidebar()">
                Cancel
            </button>

            @if (mode === 'add') {
            <button type="button" (click)="addUser()" [disabled]="userForm.invalid" class="flex-1 rounded-xl px-4 py-2.5 transition
         text-white" [class.bg-indigo-500]="(canManageUsers())" [class.hover:bg-indigo-600]="(canManageUsers())"
                [class.bg-gray-400]="!(canManageUsers())" [class.cursor-not-allowed]="!(canManageUsers())"
                [class.opacity-60]="!(canManageUsers())">
                Add User
            </button>
            }

            @if (mode === 'edit') {
            <button type="button" (click)="updateUser()" [disabled]="userForm.invalid || userForm.pristine" class="flex-1 rounded-xl px-4 py-2.5 transition
         text-white" [class.bg-indigo-500]="(canManageUsers())" [class.hover:bg-indigo-600]="(canManageUsers())"
                [class.bg-gray-400]="!(canManageUsers())" [class.cursor-not-allowed]="!(canManageUsers())"
                [class.opacity-60]="!(canManageUsers())">
                Save Changes
            </button>
            }

            @if (mode === 'delete') {
            <button type="button" (click)="deleteUser(selectedUser?.id!)" class="flex-1 rounded-xl px-4 py-2.5 transition
         text-white" [class.bg-red-500]="(canManageUsers())" [class.hover:bg-red-600]="(canManageUsers())"
                [class.bg-gray-400]="!(canManageUsers())" [class.cursor-not-allowed]="!(canManageUsers())"
                [class.opacity-60]="!(canManageUsers())">
                Delete User
            </button>
            }
        </div>
    </form>
</aside>

<app-loading-overlay [show]="isLoading()" text="Processing..."></app-loading-overlay>